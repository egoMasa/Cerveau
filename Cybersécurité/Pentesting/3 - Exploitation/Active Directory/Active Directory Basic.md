# Guide sur Active Directory

# Sommaire
1. Principe de AD
2. Domaine AD
3. Composants AD
4. Forets et domaine de confiance

# I) Principe de Active Directory
* Service qui permet de gérer et organiser les ressources informatiques dans une organisation
* Permet de gérér des ressources comme : 
	* Les hôtes
	* Système d'authenficiation
	* Autorisations
	* Politique
	* Services DNS,DHCP

# II) Principaux concepts
1. **Domaine** 
	* Un domaine est une collection d'objets, tels que des utilisateurs, des ordinateurs, des groupes, etc., qui partagent une base de données commune d'annuaire. L'idée principale d'un domaine est de centraliser l'administration des composants communs d'un réseau informatique Windows dans un référentiel unique appelé Active Directory (AD)
2. ***Contrôleur de domaine (DC)***
	* Serveur qui contient une copie de la base de données AD, responsable de l'autorisation et de l'authentification des utilisateurs dans un domaine AD, de l'application des politiques de sécurité et du déploiement des mises à jour logicielles.
	* **Authentification des utilisateurs**
		* Quand un utilisateur se connecte à un ordinateur dans le domaine, le DC vérifie les informations d'identification (nom d'utilisateur et mot de passe) et autorise ou refuse l'accès en fonction des informations stockées dans la base de données AD.
	* ***Application des politiques de groupe***
		* Ensembles de paramètres de configuration qui contrôlent le comportement des utilisateurs et des ordinateurs dans le domaine. Le DC est responsable de la distribution et de l'application de ces politiques.
	* **Résolution des noms DNS**
		* le contrôleur de domaine sert également de serveur DNS
	* **Replication des données AD**
		* Si il y a plusieurs DCs dans un domaine, ils se synchronisent entre eux pour s'assurer que toutes les copies de la base de données AD sont à jour.
	* **Maintenance du catalogue global**
		* Dans une forêt AD, un ou plusieurs DC maintiennent une copie du catalogue global
3. **Catalogue Global**
	* Index distribué contenant une représentation partielle de chaque objet dans la forêt AD. Il contient les attributs les plus utilisés dans les recherches et les informations nécessaires pour localiser un objet complet dans une forêt.
	* Lorsque des modifications sont apportées à des objets qui sont inclus dans le catalogue global, ces modifications sont répliquées à tous les contrôleurs de domaine qui contiennent une copie du catalogue global.

4. **Arbre** : 
	* Un arbre est un ensemble de domaines qui partagent un espace de noms contigu (provenant de la même racine).
	
3. **Forêt** : 
	* Une forêt est un ensemble de plusieurs domaines AD qui partagent une base de données commune d'annuaire, un schéma commun et une configuration commune (catalogue global), une configuration et un schéma. 
	* Aucune autre forêt ne peut accéder aux informations d'une autre sans un lien de confiance spécifiquement établi.
	
4. **Unités d'organisation (OU)** : 
	* Les unités d'organisation sont des conteneurs au sein d'un domaine qui peuvent contenir des utilisateurs, des groupes, des ordinateurs, et d'autres unités d'organisation.
	* utilisées pour faciliter la gestion des objets dans AD, déléguer des privilèges administratifs, appliquer des politiques de groupe.
	* structurées de manière à refléter la structure organisationnelle d'une entreprise ou d'une organisation.

# III) Interet de AD
* Avantages de AD
	1. **Gestion centralisée** : Active Directory offre une gestion centralisée de tous les utilisateurs, groupes, ressources, et autorisations sur le réseau.
	    
	2. **Sécurité** : Il assure la sécurité au niveau de l'entreprise par le biais de politiques et de contrôles d'accès basés sur les rôles.
	    
	3. **Interopérabilité** : Active Directory est compatible avec de nombreuses applications et technologies de réseau.
	    
	4. **Extensible et adaptable** : Active Directory peut être étendu pour répondre aux besoins changeants de l'entreprise. Il peut être utilisé pour gérer des petites et grandes entreprises.
	    
	5. **Facilité de déploiement et de gestion des applications** : Active Directory facilite le déploiement des applications au sein d'une organisation. Les administrateurs peuvent attribuer des applications à des utilisateurs ou à des groupes d'utilisateurs et ces applications peuvent être déployées sur les postes de travail à partir d'un emplacement centralisé.

# IV) Objets et groupes AD
* Les utilisateurs, groupes et machines, imprimantes, partages sont considérés comme des objets réseau
- **Utilisateurs** : 
	- Les utilisateurs sont un des types d'objets les plus courants dans Active Directory. 
	- Ils peuvent être authentifiés par le domaine et se voir attribuer des privilèges sur des ressources comme les fichiers ou les imprimantes. 
	- Les utilisateurs peuvent représenter des personnes (comme des employés) ou des services (comme IIS ou MSSQL), chacun ayant des privilèges spécifiques.
    
- **Machines** : 
	- Pour chaque ordinateur qui rejoint le domaine Active Directory, un objet machine est créé. 
	- Les machines sont également considérées comme des principaux de sécurité et se voient attribuer un compte. 
	- Ces comptes ont des droits limités au sein du domaine lui-même, mais sont des administrateurs locaux sur l'ordinateur attribué. 
	- Les noms des comptes de machine suivent un schéma spécifique : le nom de la machine suivi d'un signe dollar (par exemple, DC01$ pour une machine nommée DC01).
    
- **Groupes de sécurité** : 
	- Ces groupes permettent d'attribuer des droits d'accès à des fichiers ou à d'autres ressources à des groupes entiers plutôt qu'à des utilisateurs individuels. 
	- Les groupes de sécurité sont également considérés comme des principaux de sécurité et peuvent donc avoir des privilèges sur les ressources du réseau. 
	- Les groupes peuvent inclure à la fois des utilisateurs et des machines, et peuvent également inclure d'autres groupes si nécessaire.
	- Liste des groupes de sécurité 
		- **Domain Admins** : privilèges administratifs sur l'ensemble du domaine. Par défaut, ils peuvent administrer n'importe quel ordinateur du domaine, y compris les DC.
		- **Server Operators** : administrer les contrôleurs de domaine. Ils ne peuvent pas modifier l'appartenance à un groupe administratif.
		- **Backup Operators** : autorisés à accéder à n'importe quel fichier, sans tenir compte de leurs autorisations.
		- **Account Operators** : créer ou modifier d'autres comptes dans le domaine.
		- **Domain Users** : tous les comptes d'utilisateurs existants dans le domaine
		- **Domain Computers** : toutes les machines existants dans le domaine
		- **Domain Controllers** : Inclut tous les DC existants sur le domaine.

# V) Gestions utilisateurs 
* Supprimer répertoire Unités d'organisation (OU)
	* View->AdvancedFeatures->Protect object from accidental deletion
* Délégation de controleur sur OU
	* CliqueDroit->DelegateControl->Add->TAPER NOM+CHECK->Next
* Reinitialiser mot de passe 
```
PS C:\Users\phillip> Set-ADAccountPassword sophie -Reset -NewPassword (Read-Host -AsSecureString -Prompt 'New Password') -Verbose

New Password: *********

PS C:\Users\phillip> Set-ADUser -ChangePasswordAtLogon $true -Identity sophie -Verbose
```


# VI) Group Policies 

1. **Politiques de groupe (Group Policy Objects, GPO)** : Les GPO sont un ensemble de paramètres qui peuvent être appliqués aux Unités d'Organisation (OU) dans un domaine Active Directory. Elles peuvent contenir des politiques qui ciblent soit les utilisateurs, soit les ordinateurs, vous permettant de définir des paramètres spécifiques pour des machines ou des identités spécifiques.

2. **Configuration des GPO** : Pour configurer les GPO, vous pouvez utiliser l'outil de gestion des politiques de groupe. Vous créez d'abord un GPO sous les objets de politique de groupe, puis vous le liez à l'OU où vous voulez appliquer les politiques.

3. **Politique de domaine par défaut** : La politique de domaine par défaut contient des configurations de base qui s'appliquent à la plupart des domaines, y compris les politiques de mot de passe et de verrouillage de compte.

4. **Distribution des GPO** : Les GPO sont distribuées via un partage réseau appelé SYSVOL, qui est stocké dans le contrôleur de domaine. Tous les utilisateurs d'un domaine devraient généralement avoir accès à ce partage pour synchroniser périodiquement leurs GPO.

5. **Mise en œuvre des GPO** : Vous pouvez être chargé de mettre en œuvre certaines GPO pour atteindre des objectifs spécifiques, comme bloquer l'accès au panneau de configuration pour les utilisateurs non-IT, ou faire en sorte que les postes de travail et les serveurs verrouillent automatiquement leur écran après 5 minutes d'inactivité.

6. **Restriction de l'accès au panneau de configuration** : Vous pouvez créer une nouvelle GPO pour restreindre l'accès au panneau de configuration uniquement aux utilisateurs du département informatique. Vous liez ensuite cette GPO à toutes les OU qui contiennent les utilisateurs qui ne devraient pas avoir accès au panneau de configuration de leurs PC.

7. **Verrouillage automatique de l'écran** : Pour forcer le verrouillage automatique de l'écran sur les postes de travail et les serveurs après une certaine période d'inactivité, vous pouvez créer une nouvelle GPO et la lier au domaine racine. Toutes les OU enfant hériteront de cette politique. Puisque ces OU contiennent seulement des utilisateurs, toute configuration d'ordinateur dans notre GPO sera ignorée par elles.

# VII) Authentification AD

## 1) Kerberos 
* Protocole d'authentification par défaut pour les versions récentes de Windows. 
* Fonctionne en utilisant des tickets comme preuve d'authentification précédente. 
	* Un utilisateur reçoit un Ticket Granting Ticket (TGT) du Key Distribution Center (KDC), généralement installé sur le contrôleur de domaine. 
	* Ensuite, l'utilisateur utilise le TGT pour demander un Ticket Granting Service (TGS) pour accéder à des services spécifiques. 
* Ce processus évite la nécessité de transmettre les informations d'identification à chaque fois que l'utilisateur souhaite se connecter à un service.

### Etape d'authentification Kerberos 

L'authentification Kerberos est un processus assez complexe, mais il est structuré en plusieurs étapes clés. Voici un aperçu détaillé de chaque étape :

**1. L'utilisateur se connecte à son poste de travail (ou client) et entre son nom d'utilisateur et son mot de passe.**
- Le poste de travail génère un hachage du mot de passe de l'utilisateur.
  
**2. Demande de Ticket Granting Ticket (TGT) :**
- Le poste de travail crée une demande de TGT, y compris le nom d'utilisateur et un timestamp, et l'envoie au Key Distribution Center (KDC) dans le contrôleur de domaine. La demande est cryptée avec un hachage du mot de passe de l'utilisateur.

**3. Réponse du KDC avec un TGT :**
- Le KDC reçoit la demande, décrypte les informations avec le hachage du mot de passe de l'utilisateur stocké dans Active Directory, et vérifie les informations d'identification de l'utilisateur.
- Si les informations d'identification sont valides, le KDC crée un TGT et une clé de session pour l'utilisateur. Le TGT contient les informations d'identification de l'utilisateur, le timestamp et la clé de session.
- Le TGT est crypté à l'aide de la clé secrète du service de compte krbtgt (un compte de service spécifique à Kerberos) et est renvoyé au poste de travail de l'utilisateur avec la clé de session.
- À ce stade, l'utilisateur est authentifié dans le domaine.

**4. Demande de Ticket Granting Service (TGS) :**
- Lorsque l'utilisateur a besoin d'accéder à un service spécifique (par exemple, une imprimante ou un partage de fichiers), le poste de travail envoie une nouvelle demande au KDC.
- Cette demande comprend le TGT (qui est toujours crypté), un timestamp, et le nom du service auquel l'utilisateur souhaite accéder. Le tout est crypté avec la clé de session de l'utilisateur.

**5. Réponse du KDC avec un TGS :**
- Le KDC décrypte le TGT avec la clé secrète du compte de service krbtgt, récupérant ainsi la clé de session de l'utilisateur. Il utilise cette clé de session pour décrypter le reste de la demande.
- Si la demande est valide, le KDC crée un TGS pour l'utilisateur accéder au service demandé. Le TGS contient les informations d'identité de l'utilisateur, le timestamp, et une nouvelle clé de session pour communiquer avec le service.
- Le TGS est crypté avec la clé secrète du compte de service du service demandé et est renvoyé au poste de travail de l'utilisateur avec la nouvelle clé de session.

**6. Accès au service :**
- Le poste de travail envoie une demande d'accès au service requis. Cette demande comprend le TGS (toujours crypté) et un timestamp, le tout crypté avec la nouvelle clé de session.
- Le service décrypte le TGS avec sa propre clé secrète, récupérant ainsi la nouvelle clé de session. Il utilise cette clé pour décrypter le reste de la demande.
- Si la demande est valide, l'utilisateur reçoit l'accès au service.

### Failles potentielles de Kerberos 

**1. Attaque Golden Ticket :** 
Une attaque de Golden Ticket implique la création d'un Ticket Granting Ticket (TGT) falsifié. Pour ce faire, un attaquant doit obtenir le hash NTLM de l'identifiant krbtgt du domaine. Lorsque cela est réalisé, ils peuvent créer un TGT avec n'importe quel ensemble de privilèges. Ce TGT peut ensuite être présenté au Key Distribution Center (KDC) pour demander des tickets pour n'importe quel service dans le domaine. Le danger ici est que le ticket est entièrement authentifié par le KDC, il ne nécessite donc aucun accès supplémentaire une fois qu'il est créé. De plus, le ticket peut être valable jusqu'à 10 ans, ce qui permet à l'attaquant de maintenir la persistance.

**2. Attaque Silver Ticket :**
Similaire à l'attaque Golden Ticket, une attaque Silver Ticket implique la création d'un Ticket Granting Service (TGS) falsifié pour un service spécifique. Cela nécessite l'obtention du hash de mot de passe NTLM pour l'identifiant de compte de service de ce service spécifique. Bien qu'un Silver Ticket ne donne pas le même niveau d'accès qu'un Golden Ticket, il peut être utilisé pour gagner un accès non autorisé à un service spécifique.

**3. Attaque Pass-the-Ticket :**
L'attaque Pass-the-Ticket implique le vol d'un ticket Kerberos (TGT ou TGS) à partir d'un poste de travail utilisateur, puis l'utilisation de ce ticket pour accéder aux services ou aux données. Cela peut être réalisé à l'aide d'outils de vol de tickets comme Mimikatz.

**4. Attaque Kerberoasting :**
Kerberoasting est une attaque qui exploite la fonctionnalité de Kerberos qui permet à un utilisateur d'obtenir des tickets de service (TGS) pour n'importe quel service. L'attaquant demande des tickets pour tous les services, puis essaye de casser les tickets cryptés hors ligne pour obtenir les hachages de mot de passe des comptes de service.

### Protéger les failles

- Renforcement des politiques de mot de passe pour réduire le risque de cassage de mot de passe.
- Rotation régulière des mots de passe, en particulier pour les comptes de service et les comptes krbtgt(Kerberos Ticket Granting Ticket).
- Surveillance des journaux pour détecter toute activité suspecte, telle que la demande de nombreux tickets de service.
- Utilisation de solutions de sécurité avancées qui peuvent détecter des comportements anormaux associés à ces types d'attaques.


## 2) NetNTLM 
* Protocole d'authentification hérité conservé pour des raisons de compatibilité
* fonctionne selon un mécanisme de défi-réponse. 
* Le client envoie une demande d'authentification au serveur qu'il souhaite accéder. 
* Le serveur génère un nombre aléatoire et l'envoie comme un défi au client. 
* Le client combine son hash de mot de passe NTLM avec le défi pour générer une réponse, qui est ensuite envoyée au serveur pour vérification. 
* Le serveur transmet le défi et la réponse au contrôleur de domaine pour vérification. 
* Si la réponse recalculée du contrôleur de domaine correspond à la réponse originale du client, l'authentification est réussie.
### Etape d'authentification NetNTLM 
1. **Début de l'authentification** : Lorsqu'un client souhaite accéder à un service sur un serveur, il envoie une demande d'authentification à ce serveur.
    
2. **Émission d'un défi par le serveur** : En réponse à cette demande d'authentification, le serveur génère un nombre aléatoire, appelé "défi" (ou "challenge"), et l'envoie au client.
    
3. **Réponse du client au défi** : Le client reçoit ce défi et l'utilise pour générer une réponse. Pour ce faire, le client combine le défi avec le hachage de son mot de passe NTLM (et d'autres données connues), puis envoie cette réponse au serveur. Il est important de noter que le hachage du mot de passe n'est jamais envoyé directement sur le réseau pour des raisons de sécurité.
    
4. **Vérification de la réponse par le serveur** : Lorsque le serveur reçoit la réponse du client, il ne peut pas la vérifier lui-même car il ne connaît pas le hachage du mot de passe du client. À la place, le serveur transmet le défi et la réponse au contrôleur de domaine.
    
5. **Vérification de la réponse par le contrôleur de domaine** : Le contrôleur de domaine utilise le défi pour recalculer la réponse et la compare à la réponse originale envoyée par le client. Si les deux correspondent, le contrôleur de domaine confirme que l'authentification est réussie. Dans le cas contraire, l'accès est refusé. Le contrôleur de domaine envoie ensuite le résultat de l'authentification au serveur.
    
6. **Réponse du serveur au client** : Enfin, le serveur transmet le résultat de l'authentification au client. Si l'authentification a réussi, le client peut maintenant accéder au service demandé.
    
Note : Si un compte local est utilisé à la place d'un compte de domaine, le serveur peut vérifier la réponse au défi lui-même sans avoir besoin d'interagir avec le contrôleur de domaine, car il a le hachage du mot de passe stocké localement dans son SAM (Security Account Manager).

### Failles potentielles de NetNTLM 

1. **Attaques de relais NTLM** : Ces attaques se produisent lorsqu'un attaquant intercepte la communication entre un client et un serveur et "relaie" les messages d'authentification d'une victime vers une autre machine sur le réseau. Cela peut permettre à l'attaquant de s'authentifier en tant que victime sur une autre machine sans jamais connaître le mot de passe de la victime.
    
2. **Attaques par force brute et par dictionnaire** : Comme le protocole NTLM utilise un hachage non salé, il est vulnérable aux attaques par force brute et par dictionnaire. Un attaquant qui a capturé un hachage NTLM peut essayer de le "casser" en utilisant une attaque par force brute ou par dictionnaire pour découvrir le mot de passe original.
    
3. **Attaques Pass-the-Hash** : Dans une attaque Pass-the-Hash, un attaquant qui a réussi à obtenir un hachage NTLM peut l'utiliser pour s'authentifier auprès d'un service ou d'un serveur sans avoir besoin de connaître le mot de passe en clair. Cela est possible parce que NTLM utilise le hachage du mot de passe pour l'authentification plutôt que le mot de passe lui-même.
    
4. **Attaques de déchiffrement LM** : Les versions plus anciennes de NTLM (avant NTLMv2) utilisaient le système de hachage Lan Manager (LM), qui est connu pour être faible et facile à casser. Un attaquant qui capture un hachage LM peut souvent le déchiffrer pour obtenir le mot de passe original.