# Guide Nmap

# I) Généralités
* Outils se scanning de réseau open-source
* Permet la détection des hôtes actifs sur un réseau ainsi que les ports et services actifs
* Le but : Obtenir des informations sur la topologie globale du réseau comme : 
	* IP actives
	* Système d'exploitation
	* Version de logiciels
	* Pare-feu actifs
* Rappel sur connexion TCP
	* Etablissement de la connexion
		1. SYN vers serveur
		2. SYN/ACK vers client
		3. ACK vers serveur
	* Fermeture de la connexion
		1. RST : Ferme complétement la connexion
		2. FIN : Message formelle de fin de connexion finale
* Différents états de ports 
	* OPEN
	* FILTERED
	* CLOSE
* Différents flag TCP
	* SYN : Initie la connexion
	* ACK : Réponse à un SYN
	* FIN : Fin de la connexion
	* RST : Fermeture de la connexion
	* PSH : Forcer la réception sans le SYN/ACK
	* URG : Passe en priorité 
	* NULL : Aucun flag, vide
* Comportement par défait de nmap
	* Scan TCP SYN sur les 1000 ports courants 
# II) Différents types de scans

## 1) Détection des services et ports

* ***TCP SYN (-sS)***
	* Connexion non complète
		* Envoi d'un paquet SYN et si il recoit un SYN/ACK le port est ouvert
		* Ne renvoie pas de réponse ACK
	* Port ouvert : SYN/ACK.
	* Port fermé : RST
```
nmap -sS @ip
```
* ***TCP CONNECT (-sT)***
	* Connexion complète 
	* Envoi d'un paquet SYN -> SYN/ACK -> ACK
	* Port ouvert : Rien
	* Port fermé : RST
```
nmap -sT @ip
```
* ***UDP (-sU)***
	* Sans connexion
	* Envoi d'un paquet UDP vide
	- Port ouvert/filtré : Rien
	- Port fermé : ICMP "Port Unreachable"
```
nmap -sU --top-ports 20 @ip 
```
---
* ***FIN (-sF)***
	* Envoi paquet TCP avec flag FIN
	- Port ouvert : Aucune réponse (rien)
	- Port fermé : Récupération d'un paquet RST.
```
nmap -sF @ip 
```
* ***XMAS Tree (tout les flags) (-sX)***
	* Envoi paquet TCP avec flag FIN,URG,PSH
	- Port ouvert : Aucune réponse (rien)
	- Port fermé : Récupération d'un paquet RST.
```
nmap -sX @ip 
```
* ***NULL (aucun flags) (-sN)***
	* Envoi d'un paquet avec aucun flag
	- Port ouvert : Aucune réponse (rien)
	- Port fermé : Récupération d'un paquet RST.
```
nmap -sN @ip 
````
* ***ACK (-sA)***
	* Envoi paquet TCP avec flag ACK
	* Ne détermine pas si ports ouverts mais si filtré ou non 
	* 2 réponses possibles : RST et ICMP "Port Unreachable"
```
nmap -sA @ip 
````
---
* ***Scan des versions (-sV)***
	* Envoi paquet spécifique sur un service et en analysant la réponse pour détecter la version
	* Comparaison modèle de réponse avec signature de la base de données 'nmap-service-probes'
```
nmap -sV @ip
```
* ***Scan vulnérabilités via scripts (-sC)*** 
	* Exécute des scripts qui fournissent des informations supplémentaires sur les services et les vulnérabilités.
```
nmap -sC @ip
nmap --script ...
```


## 2) Scan du réseau et des hôtes

*  ***ICMP (-sn)***
```
nmap -sn @ip/masque
````
* ARP (-PR)
```
nmap -sn -PR @ip/masque
````
* No ping = On désactive la reconaissance 
```
nmap -Pn @ip/masque
````
# III) Commandes de scans basiques
* Scanner les ports
```
nmap -p 80,443 @ip
nmap -p 1-1024 @ip
```
* Scanner réseau
```
nmap 192.168.1.0-254
nmap 192.168.0.0/24
nmap 192.168.0-255.0-255
```
* Détecter protocoles de communications IP pris en charges par la cible (ICMP,TCP,UDP,ARP)
```
nmap -sO @ip
```
# III) Scripts intégrés NSE
* Ces scripts sont effectuer pour répondre à des taches différentes :
	1. Détecter de failles avancée de services 
	2. Obtenir des informations plus précises sur les cibles
	3. Exploitation de vulnérabilités
	4. Recherche de configuration mal sécurisées
* Permet l'automatisation de certaines tâches
* Les scripts sont situés dans ***/usr/share/nmap/scripts/***
* Différentes catégories de scripts 
	1. ***safe*** : N'affecte pas la cible
	2. ***intrustive*** : Affecte la cible
	3. ***vuln*** : Scan les vulnérabilités
	4. ***exploit*** : Tente une exploitation de faille 
	5. ***auth*** : Tente les connexions classiques (ftp avec anonymous,...)
	6. ***brute*** : Tente une attaque bruteforce pour les services en cours
	7. ***discovery*** : Tente d'interroger les services en cours pour avoir infos supplémentaire (SNMP par exemple)
* Exécuter un script NSE
```
nmap -sC @ip
nmap --script=@nomscript1,@nomscript2
nmap --script=@categorie.@argument
nmap --script http-put --script-args http-put.url='/dav/shell.php',http-put.file='./shell.php'
```
* Trouver un script pour un protocole précis
```
grep "ftp" /usr/share/nmap/scripts/script.db
ls -l /usr/share/nmap/scripts/*ftp*
```
* Mettre à jour la liste des scripts
```
sudo apt update && sudo apt install nmap
```

# IV) Agir face au firewall 
* Certaines cibles via leur firewall intégré, bloque les requêtes ICMP qu'envoie à l'origine nmap et il considère la machine comme morte et ne prend pas la peine de scanner ses ports pour des questions de rapidité
* On peut renseigner à nmap de considérer les hôtes comme vivant de base et passer directement au ports via l'option (-Pn)
* Conséquence : Durée du scan d'un réseau
--- 
1. Utilisé scan ARP ***(-PR)*** plutôt que ICMP : 
```
nmap -sn -PR @reseau/m
```
2. Désactiver ping préalable ***(-Pn)*** : 
```
nmap -Pn @ip
```
3. Fragmenter les paquets ***(-f)*** : 
```
nmap -f @ip
```
4. Contrôler la taille des paquets ***(--mtu)*** : 
```
nmap --mtu @nombre @ip
```
--- 
# CheatSheet

1. Lancer un scan de ports TCP sur une adresse IP spécifique :
```
nmap -p <port> <adresse_IP>
```

2. Lancer un scan de ports TCP sur un ensemble d'adresses IP :
```
nmap -p <port> -iL <fichier_adresses_IP>
```

3. Lancer un scan de ports TCP sur un ensemble de ports spécifiques :
```
nmap -p <port1,port2,port3> <adresse_IP>
```

4. Lancer un scan de ports TCP sur un range de ports :
```
nmap -p <port_début>-<port_fin> <adresse_IP>
```

5. Lancer un scan de ports TCP sur les ports les plus couramment utilisés :
```
nmap -p- --top-ports <nombre_ports> <adresse_IP>
```

6. Lancer un scan de ports TCP sur tous les ports :
```
nmap -p- <adresse_IP>
```

7. Lancer un scan de ports UDP :
```
nmap -sU -p <port> <adresse_IP>
```

8. Lancer un scan de ports TCP et UDP simultanément :
```
nmap -p <port> -sU <adresse_IP>
```

9. Lancer un scan de ports avec une technique de scan spécifique (ex : SYN scan, connect scan) :
```
nmap -p <port> -s<technique_scan> <adresse_IP>
```

10. Lancer un scan de ports en utilisant un script NSE spécifique :
```
nmap -p <port> --script <nom_script> <adresse_IP>
```

11. Lancer un scan de ports en utilisant un fichier de scripts NSE personnalisé :
```
nmap -p <port> --script <fichier_scripts> <adresse_IP>
```

12. Lancer un scan de ports en utilisant une option d'optimisation pour la vitesse :
```
nmap -p <port> --min-rate <vitesse> <adresse_IP>
```

13. Lancer un scan de ports en utilisant une option d'optimisation pour la précision :
```
nmap -p <port> --max-retries <nombre_tentatives> <adresse_IP>
```

14. Lancer un scan de ports en utilisant un fichier de sortie personnalisé :
```
nmap -p <port> -oN <fichier_sortie> <adresse_IP>
```

15. Lancer un scan de ports en utilisant une liste de ports exclus :
```
nmap -p <port> --exclude-ports <port1,port2,port3> <adresse_IP>
```

16. Lancer un scan de découverte d'hôtes sur un réseau :
```
nmap -sn <adresse_IP/masque>
```

17. Lancer un scan de vulnérabilités sur un hôte :
```
nmap -p <port> --script vuln <adresse_IP>
```

18. Lancer un scan de version et d'OS :
```
nmap -sV -O <adresse_IP>
```

19. Lancer un scan en utilisant un fichier de configuration personnalisé :
```
nmap -p <port> -oX <fichier_sortie> --config <fichier_config> <adresse_IP>
```

# Résumé des options :

- -p : Spécifie le port ou les ports à scanner.
- -iL : Spécifie un fichier contenant une liste d'adresses IP à scanner.
- -sU : Utilise le protocole UDP pour le scan de ports.
- -s : Spécifie la technique de scan à utiliser (ex: SYN scan, connect scan).
- --top-ports : Spécifie le nombre de ports les plus couramment utilisés à scanner.
- -sV : Active la détection de version des services sur les ports scannés.
- -O : Active la détection du système d'exploitation sur l'hôte scanné.
- --script : Spécifie un script NSE à exécuter pendant le scan.
- --min-rate : Spécifie la vitesse minimale du scan.
- --max-retries : Spécifie le nombre maximum de tentatives pour le scan.
- -oN : Spécifie le fichier de sortie en format normal.
- --exclude-ports : Spécifie les ports à exclure du scan.
- -sn : Effectue un scan de découverte d'hôtes (ping scan).
- --config : Spécifie un fichier de configuration personnalisé.
