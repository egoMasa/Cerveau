# 1) Présentation de Nmap
La reconnaissance est la première étape d’un test d’intrusion et consiste à collecter un maximum d’informations sur la cible avant toute tentative d’exploitation. **Nmap** (Network Mapper) est l’un des outils les plus puissants pour cette phase. Il permet d’identifier les hôtes actifs, les services exposés, les versions de logiciels, les systèmes d’exploitation et les éventuelles vulnérabilités.

## Objectif d'une reconnaissance avec nmap
- Identifier les ***machines actives*** sur un réseau.
- Découvrir les ***ports ouverts*** et ***services accessibles***.
- Déterminer les ***versions des services*** pour détecter d’éventuelles vulnérabilités.
- Identifier le ***système d’exploitation*** de la cible.
- Évaluer la ***présence des mécanismes de défense*** (firewall, IPS, IDS).

## Principales étapes de reconnaissance
- **Détection des hôtes actifs** (ping sweep, ARP scan).
- **Scan des ports** (TCP, UDP).
- **Détection des services et versions** (service fingerprinting).
- **Identification du système d’exploitation** (OS fingerprinting).
- **Évaluation des défenses et contournement des protections.**

# 2) Fonctionnement de nmap
Nmap utilise **différents protocoles** pour interagir avec les systèmes cibles :
- **ICMP** (ping) pour la découverte d’hôtes.
- **TCP SYN /TCP Connect/UDP** pour la détection des ports ouverts.
- **TCP ACK et FIN** pour contourner les pare-feux.
- **Techniques avancées** comme le **idle scan** pour masquer la source du scan.

## Processus par défaut d'un scan nmap
- **DNS Resolution** : Il tente de résoudre le nom de l’hôte si une adresse IP est fournie.
- **Ping Sweep** : Envoie un **ICMP Echo Request** pour voir si la cible est en ligne.
- **Port Scanning** : Envoie des paquets avec différents flags pour déterminer l’état des ports.
- **Service Fingerprinting** : Essaye d’identifier les services et versions des ports ouverts.
- **OS Detection** : Analyse les réponses TCP/IP pour deviner le système d’exploitation.

## Questions de fonctionnement 
1. Comment Nmap détecte des services actifs et problème avec UDP
2. Comment Nmap détecte le service et la version
3. Comment Nmap détecte le système d’exploitation










--- 

### Comportement de base de nmap
- **Ports**: Par défaut, Nmap scanne les 1 000 ports TCP les plus couramment utilisés.
- **Vitesse**: Si aucune option de timing n'est spécifiée, Nmap choisit un timing basé sur le réseau et la cible. L'option `-T3` est généralement le niveau de timing par défaut.
- **Scripts**: Les scripts ne sont pas exécutés par défaut. Vous devez utiliser `-sC` ou `--script` pour spécifier les scripts que vous voulez exécuter.
- **Technique de scan**: Nmap utilisera le scan SYN (ou "half-open" scan) par défaut si exécuté en tant que root. Sinon, il utilise le scan connect(). Le scan SYN est plus rapide et moins intrusif que le scan connect(), car il n'établit jamais de connexion complète.

### Options courantes
* -A : combinaison de plusieurs fonctionnalités avancées.
	1. **Détection du système d'exploitation (`-O`)** : Nmap essaiera de déterminer le système d'exploitation (OS) de la cible.
	2. **Détection de version (`-sV`)** : Nmap déterminera les services en cours d'exécution sur les ports ouverts et tentera d'identifier leur version spécifique.
	3. **Script scan (`-sC`)** : Exécute un ensemble de scripts NSE (Nmap Scripting Engine) par défaut. Ces scripts sont généralement considérés comme "sûrs" à exécuter, mais ils peuvent être très informatifs et révéler des informations supplémentaires sur la cible.
	4. **Traceroute (`--traceroute`)** : Nmap exécutera un traceroute vers la cible pour déterminer le chemin des paquets à travers le réseau.
* TX : Vitesse d'execution du scan 
	1. **T0 (paranoiac)**: Extrêmement lent. Il envoie des paquets de manière très espacée pour réduire la probabilité d'être détecté par des dispositifs comme les IDS (systèmes de détection d'intrusion) ou les IPS (systèmes de prévention d'intrusion).
	2. **T1 (sneaky)**: Encore lent, mais pas autant que T0. Il est conçu pour être discret, mais est plus rapide que le mode paranoiac.
	3. **T2 (polite)**: Plus rapide que T1 et T0, mais prend encore des mesures pour ne pas surcharger le réseau ou la cible. Il envoie des paquets à un rythme qui devrait éviter d'encombrer le réseau.
	4. **T3 (normal)**: C'est le mode par défaut de Nmap. Il n'a pas de retard spécial entre les paquets comme les modes précédents. Dans ce mode, Nmap prend des décisions basées sur les réponses du réseau, ajustant ses délais en conséquence.
	5. **T4 (aggressive)**: Plus rapide que T3. Il envoie des paquets plus rapidement, en réduisant considérablement les délais. Il existe un risque plus élevé de fausser certains résultats ou d'engorger les réseaux avec cette option.
	6. **T5 (insane)**: C'est le mode le plus rapide. Il est utile lorsque la cible est sur un réseau local ou lorsqu'on sait que la cible peut gérer une telle quantité de trafic. Il peut facilement causer des problèmes sur les réseaux ou avec les cibles s'ils ne sont pas préparés à gérer une telle charge.

### Commandes nmap
1. Scan de port nmap
```
nmap [IP_CIBLE] -p- -T4 -A -oN result_nmap.txt
nmap [IP_CIBLE] -p- -T4 -sC -sV -oN result_nmap.txt
```
2. Lister les scripts NSE
```
ls /usr/share/nmap/scripts/
ls /usr/share/nmap/scripts/ | grep [PROTOCOLE]
````
3. Executer scripts NSE
```
nmap -p [PORT] --script [NOMSCRIPT] [IP_CIBLE]
nmap -p [PORT] --script [NOMSCRIPT1],[NOMSCRIPT2] [IP_CIBLE]
```

